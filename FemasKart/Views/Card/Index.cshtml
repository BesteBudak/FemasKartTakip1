
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<head>
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    #example td:last-child .d-flex {
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    @@media (max-width: 768px) {
        #example
    {
        display: block;
        width: 100%;
        overflow-x: auto;
        white-space: nowrap; /* satırların alt satıra kaymasını engeller */
    }

    }
</style>
</head>

<div class="content-wrapper">
    <!-- Content -->
    <!-- DataTable_Başlangıç -->
    <div class="container mt-6">
        <!-- Bildirim Alanı -->
        <div id="alert-container"></div>

        <div class="card">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
              
                <div class="d-flex gap-2">
                    <div class="dt-buttons btn-group">
                       @*  <button class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">Export</button> *@
                        <ul class="dropdown-menu"></ul>
                    </div>
                    <button class="btn btn-primary create-new">
                        <i class="bi bi-plus-circle"></i>
                        <span>Kart Ekle</span>
                    </button>
                </div>
            </div>

            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6 d-flex align-items-center">
                        <label class="me-2"></label>
                        <select id="dt-length" class="form-select w-auto">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="ms-2">Kayıt</span>
                    </div>
                    <div class="col-md-6 d-flex justify-content-md-end mt-2 mt-md-0">
                        <label class="me-2">Arama:</label>
                        <input type="search" id="dt-search" class="form-control w-auto">
                    </div>
                </div>
                <table id="example" class="table table-striped table-bordered display">
                    <thead>
                        <tr>
                            <th>Kart Tanımlaması</th>
                            <th>Kart Stok No</th>
                            <th>Marka</th>
                            <th>Tedarikçi Kodu</th>
                            <th>Atanmış Yazılım</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>

                            <td>Kart A</td>
                            <td>Marka X</td>
                            <td>KOD123</td>
                            <td>Tür 1</td>
                            <td>STK-001</td>
                            <td>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-sm btn-secondary btn-edit">Düzenle</button>
                                    <button class="btn btn-sm btn-secondary btn-delete">Sil</button>
                                    <button class="btn btn-sm btn-info btn-details btn-details">Detay</button>
                                    <button class="btn btn-success yazilim-tanimla">
                                        <i class="bi bi-link"></i>
                                        <span> Yeni Yazılım Tanımı</span>
                                    </button>

                                </div>
                            </td>
                        </tr>
                        <tr>

                            <td>Kart B</td>
                            <td>Marka Y</td>
                            <td>KOD456</td>
                            <td>Tür 2</td>
                            <td>STK-002</td>
                            <td>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-sm btn-secondary btn-edit">Düzenle</button>
                                    <button class="btn btn-sm btn-secondary btn-delete">Sil</button>
                                    <button class="btn btn-sm btn-info btn-details btn-details">Detay</button>
                                    <button class="btn btn-success yazilim-tanimla">
                                        <i class="bi bi-link"></i>
                                        <span> Yeni Yazılım Tanımla</span>
                                    </button>

                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- kart ekle başlangıcı -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <form id="createForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Yeni Kart Ekle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Kart Bilgileri -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Kart Stok No</label>
                                <input type="text" class="form-control" name="kartStokKodu" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kart Tanımlaması</label>
                                <input type="text" class="form-control" name="kartTanımlaması" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kart Tipi</label>
                                <input type="text" class="form-control" name="kartTipi" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Marka</label>
                                <input type="text" class="form-control" name="marka" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Revizyon No</label>
                                <input type="text" class="form-control" name="revizyonNo" required />
                            </div>
                              <div class="col-md-6">
                                <label class="form-label">Tedarikçi Kodu</label>
                                <input type="text" class="form-control" name="tedarikciKodu" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Açıklama</label>
                                <input type="text" class="form-control" name="acıklama" required />
                            </div>
                        </div>

                        <hr />

                        <!-- Fotoğraf Yükleme -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Karta Ait Fotoğraflar (Max 3)</label>
                            <input type="file" class="form-control photo-input" data-preview="#previewKarti" accept="image/*" multiple />
                            <div id="previewKarti" class="d-flex gap-2 mt-2 flex-wrap"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Programlayıcı Fotoğrafları (Max 3)</label>
                            <input type="file" class="form-control photo-input" data-preview="#previewProg" accept="image/*" multiple />
                            <div id="previewProg" class="d-flex gap-2 mt-2 flex-wrap"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Kablo Bilgisi Fotoğrafları (Max 3)</label>
                            <input type="file" class="form-control photo-input" data-preview="#previewKablo" accept="image/*" multiple />
                            <div id="previewKablo" class="d-flex gap-2 mt-2 flex-wrap"></div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- kart ekle bitişi -->

    <!-- Kart Detayları Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kart Detayları</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="fw-bold">Kart Bilgileri</h6>
                    <ul class="list-group mb-3" id="detailsInfo"></ul>

                    <h6 class="fw-bold">Karta Ait Fotoğraflar</h6>
                    <div id="detailsKarti" class="d-flex gap-2 flex-wrap mb-3"></div>

                    <h6 class="fw-bold">Programlayıcı Fotoğrafları</h6>
                    <div id="detailsProg" class="d-flex gap-2 flex-wrap mb-3"></div>

                    <h6 class="fw-bold">Kablo Bilgisi Fotoğrafları</h6>
                    <div id="detailsKablo" class="d-flex gap-2 flex-wrap mb-3"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Kart Detayları Modal bitişi-->

    <!-- Kart Düzenleme Modal -->
    <div class="modal fade" id="editKartModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <form id="editKartForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Elektronik Kart Düzenleme Formu</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Kart Stok No</label>
                                <input type="text" class="form-control" name="stokNo" id="stokNo" readonly />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kart Tanımlaması</label>
                                <input type="text" class="form-control" name="kartTanimlamasi" id="kartTanimlamasi" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kart Tipi</label>
                                <input type="text" class="form-control" name="kartTipi" id="kartTipi" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Marka</label>
                                <input type="text" class="form-control" name="marka" id="marka" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Revizyon No</label>
                                <input type="text" class="form-control" name="revizyonNo" id="revizyonNo" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tedarikçi Kodu</label>
                                <input type="text" class="form-control" name="tedarikciKodu" id="tedarikciKodu" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Açıklama</label>
                                <textarea class="form-control" name="aciklama" id="aciklama"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Kart Düzenleme Modal bitişi -->
    <!-- Yazılım Tanımla Modal -->
    <div class="modal fade" id="yazilimTanimlaModal" tabindex="-1">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content">
                <form id="yazilimTanimlaForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Yazılım Tanımla</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label class="form-label">Mevcut Yazılımlar</label>
                        <select class="form-select" id="mevcutYazilimlar" name="yazilimId" required>
                            <!-- Dinamik doldurulacak -->
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Yazılım Tanımla Modal bitiş -->


    <!-- Popup Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bilgi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="actionMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tamam</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Popup Modal bitişi-->
</div>




<!-- Core JS -->
<!-- build:js assets/vendor/js/core.js -->
<script src="~/sneat-1.0.0/assets/vendor/libs/jquery/jquery.js"></script>
<script src="~/sneat-1.0.0/assets/vendor/libs/popper/popper.js"></script>
<script src="~/sneat-1.0.0/assets/vendor/js/bootstrap.js"></script>
<script src="~/sneat-1.0.0/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>


<script src="~/sneat-1.0.0/assets/vendor/js/menu.js"></script>
<!-- endbuild -->
<!-- Vendors JS -->
<script src="~/sneat-1.0.0/assets/vendor/libs/apex-charts/apexcharts.js"></script>

<!-- Main JS -->
<script src="~/sneat-1.0.0/assets/js/main.js"></script>

<!-- Page JS -->
<script src="~/sneat-1.0.0/assets/js/dashboards-analytics.js"></script>

<!-- Place this tag in your head or just before your close body tag. -->
<!-- Icons (Bootstrap Icons) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

 <!-- DataTables Responsive CSS -->
<link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">


<!-- DataTables Responsive JS -->
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>


<script async defer src="https://buttons.github.io/buttons.js"></script>


<script>
    $(document).ready(function () {
      // DataTable başlat
      let table = $("#example").DataTable({
        dom: "Brtip",
        buttons: [
          { extend: "copy", className: "dropdown-item" },
          { extend: "csv", className: "dropdown-item" },
          { extend: "excel", className: "dropdown-item" },
          { extend: "pdf", className: "dropdown-item" },
          { extend: "print", className: "dropdown-item" },
        ],
        language: {
      decimal: ",",
      thousands: ".",
      search: "Ara:",
      lengthMenu: "Sayfada _MENU_ kayıt göster",
      info: "_TOTAL_ kayıttan _START_ - _END_ arası gösteriliyor",
      infoEmpty: "Gösterilecek kayıt yok",
      infoFiltered: "(_MAX_ kayıt içerisinden filtrelendi)",
      loadingRecords: "Yükleniyor...",
      zeroRecords: "Eşleşen kayıt bulunamadı",
      emptyTable: "Tabloda veri yok",
      paginate: {
        first: "İlk",
        previous: "Önceki",
        next: "Sonraki",
        last: "Son"
      },
      buttons: {
        copy: "Kopyala",
        csv: "CSV",
        excel: "Excel",
        pdf: "PDF",
        print: "Yazdır"
      }
    }
    
      });

      // Export dropdown’u DataTables butonlarıyla doldur
      table.buttons().container().appendTo(".dt-buttons .dropdown-menu");

      // Length dropdown senkronize et
      $("#dt-length").on("change", function () {
        table.page.len($(this).val()).draw();
      });

      // Search input senkronize et
      $("#dt-search").on("keyup", function () {
        table.search(this.value).draw();
      });

      // Popup fonksiyonu
      function showPopup(message) {
        $("#actionMessage").text(message);
        let modal = new bootstrap.Modal(document.getElementById("actionModal"));
        modal.show();
      }

      // // Düzenle butonu
      // $("#example").on("click", ".btn-edit", function () {
      //   let row = $(this).closest("tr");
      //   let btn = $(this);

      //   if (btn.text() === "Düzenle") {
      //     row.find("td").not(":last").attr("contenteditable", "true").addClass("table-warning");
      //     btn.text("Kaydet");
      //   } else {
      //     row.find("td").not(":last").removeAttr("contenteditable").removeClass("table-warning");
      //     btn.text("Düzenle");
      //     showPopup("Satır başarıyla güncellendi ✅");
      //   }
      // });

       // Düzenle butonu (popup aç)
    $("#example").on("click", ".btn-edit", function () {
        let row = $(this).closest("tr");
        let cells = row.find("td");

        // Modal içini doldur
        $("#stokNo").val(cells.eq(1).text());         // STK kodu
        $("#kartTanimlamasi").val(cells.eq(0).text());
        $("#kartTipi").val(cells.eq(4).text());
        $("#marka").val(cells.eq(2).text());
        $("#revizyonNo").val(cells.eq(3).text());
        $("#tedarikciKodu").val("aaa"); // backend’den gelecekse AJAX ile doldur
        $("#aciklama").val(cells.eq(6).text());

        // Modalı aç
        new bootstrap.Modal(document.getElementById("editKartModal")).show();
    });

        // Yazılım Tanımla butonu
    $(".yazilim-tanimla").on("click", function () {
        let select = $("#mevcutYazilimlar");
        select.empty();

        // Burada mevcut yazılımları backend’den AJAX ile çekebilirsin
        // Şimdilik örnek sabit veri:
        let yazilimlar = [
            { id: 1, ad: "Yazılım A" },
            { id: 2, ad: "Yazılım B" },
            { id: 3, ad: "Yazılım C" }
        ];

        yazilimlar.forEach(y => {
            select.append(`<option value="${y.id}">${y.ad}</option>`);
        });

        new bootstrap.Modal(document.getElementById("yazilimTanimlaModal")).show();
    });

    // Yazılım Tanımla kaydetme
    $("#yazilimTanimlaForm").on("submit", function (e) {
        e.preventDefault();
        let secilenYazilim = $("#mevcutYazilimlar").val();
        let secilenYazilimAdi = $("#mevcutYazilimlar option:selected").text();

        // Burada seçilen yazılımı backend’e gönderebilirsin
        // örn: $.post("/Kart/YazilimTanimla", { yazilimId: secilenYazilim })

        $("#yazilimTanimlaModal").modal("hide");
        showPopup(`"${secilenYazilimAdi}" yazılımı başarıyla tanımlandı ✅`);
    });



    // Kaydetme işlemi
    $("#editKartForm").on("submit", function (e) {
        e.preventDefault();
        // Burada AJAX ile backend'e güncelleme yapılabilir
        // örn: $.post("/Kart/Update", $(this).serialize())

        $("#editKartModal").modal("hide");
        showPopup("Kart bilgileri başarıyla güncellendi ✅");
    });


      // Sil butonu
      $("#example").on("click", ".btn-delete", function () {
      let row = $(this).closest("tr");

      Swal.fire({
        title: "Emin misin?",
        text: "Bu satırı silmek istediğine emin misin?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Evet, sil",
        cancelButtonText: "İptal",
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33"
      }).then((result) => {
        if (result.isConfirmed) {
          table.row(row).remove().draw();
          showPopup("Satır başarıyla silindi 🗑️");
        }
      });
    });
      // $("#example").on("click", ".btn-delete", function () {
      //   let row = $(this).closest("tr");
      //   if (confirm("Bu satırı silmek istediğine emin misin?")) {
      //     table.row(row).remove().draw();
      //     showPopup("Satır başarıyla silindi 🗑️");
      //   }
      // });

      // Yeni kayıt modalını aç
      $(".create-new").on("click", function () {
        $("#createForm")[0].reset();
        $("#createForm .d-flex").empty(); // önceki previewleri temizle
        let modal = new bootstrap.Modal(document.getElementById("createModal"));
        modal.show();
      });

      // Fotoğraf seçildiğinde önizleme göster
      $(document).on("change", ".photo-input", function () {
        let previewId = $(this).data("preview");
        let previewBox = $(previewId);
        previewBox.empty();

        let files = this.files;
        if (files.length > 3) {
          alert("En fazla 3 fotoğraf yükleyebilirsiniz!");
          this.value = "";
          return;
        }

        Array.from(files).forEach((file) => {
          let reader = new FileReader();
          reader.onload = function (e) {
            let img = $("<img>")
              .attr("src", e.target.result)
              .addClass("img-thumbnail")
              .css({ width: "100px", height: "100px", objectFit: "cover" });
            previewBox.append(img);
          };
          reader.readAsDataURL(file);
        });
      });

      // Fotoğrafları saklamak için bellek
      let cardPhotos = {}; // {rowIndex: {karti:[], prog:[], kablo:[]}}

      // Yeni kayıt formu submit
      $("#createForm").on("submit", function (e) {
        e.preventDefault();

        let formData = new FormData(this);

        let newRow = [
          "-", // ID backend’den gelecek
          formData.get("kartAdi"),
          formData.get("marka"),
          formData.get("yazilimKodu"),
          formData.get("yazilimTuru"),
          formData.get("stokKodu"),
          `<div class="d-flex gap-2">
             <button class="btn btn-sm btn-secondary btn-edit">Düzenle</button>
             <button class="btn btn-sm btn-secondary btn-delete">Sil</button>
             <button class="btn btn-sm btn-info btn-details">Detaylar</button>
           </div>`,
        ];

        let rowNode = table.row.add(newRow).draw().node();
        let rowIndex = table.row(rowNode).index();

        // Fotoğrafları base64 olarak sakla
        cardPhotos[rowIndex] = { karti: [], prog: [], kablo: [] };

        $("#previewKarti img").each(function () {
          cardPhotos[rowIndex].karti.push($(this).attr("src"));
        });
        $("#previewProg img").each(function () {
          cardPhotos[rowIndex].prog.push($(this).attr("src"));
        });
        $("#previewKablo img").each(function () {
          cardPhotos[rowIndex].kablo.push($(this).attr("src"));
        });

        $("#createModal").modal("hide");
        alert("Yeni kart başarıyla eklendi ✅");
      });

      // Detaylar butonu
      $("#example").on("click", ".btn-details", function () {
        let row = table.row($(this).closest("tr"));
        let rowIndex = row.index();
        let data = row.data();

        // Kart bilgilerini doldur
        $("#detailsInfo").html(`
          <li class="list-group-item"><strong>Kart Stok No:</strong> ${data[1]}</li>
          <li class="list-group-item"><strong>Kart Tanımlaması:</strong> ${data[0]}</li>
          <li class="list-group-item"><strong>Kart Tipi:</strong> ${data[2]}</li 
          <li class="list-group-item"><strong>Marka:</strong> ${data[3]}</li>
          <li class="list-group-item"><strong>Revizyon No:</strong> ${data[4]}</li>
          <li class="list-group-item"><strong>Tedarikçi Kodu:</strong> ${data[5]}</li>
          <li class="list-group-item"><strong>Açıklama:</strong> ${data[6]}</li>
        `);

        // Fotoğrafları doldur
        function renderPhotos(container, photos) {
          $(container).empty();
          photos.forEach((src) => {
            let img = $("<img>")
              .attr("src", src)
              .addClass("img-thumbnail")
              .css({ width: "120px", height: "120px", objectFit: "cover" });
            $(container).append(img);
          });
        }

        renderPhotos("#detailsKarti", cardPhotos[rowIndex]?.karti || []);
        renderPhotos("#detailsProg", cardPhotos[rowIndex]?.prog || []);
        renderPhotos("#detailsKablo", cardPhotos[rowIndex]?.kablo || []);

        let modal = new bootstrap.Modal(document.getElementById("detailsModal"));
        modal.show();
      });
    });
</script> 



