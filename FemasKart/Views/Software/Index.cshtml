 

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        #example td:last-child .d-flex {
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        @@media (max-width: 768px) {
            #example {
                display: block;
                width: 100%;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
    </style>
</head>

<div class="content-wrapper">
    <div class="container mt-6">
        <div class="card">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
                <div class="d-flex gap-2">
                    <div class="dt-buttons btn-group"><ul class="dropdown-menu"></ul></div>
                    <button class="btn btn-primary create-new">
                        <i class="bi bi-plus-circle"></i><span> Yeni Yazılım Ekle</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6 d-flex align-items-center">
                        <label class="me-2"></label>
                        <select id="dt-length" class="form-select w-auto">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="ms-2">Kayıt</span>
                    </div>
                    <div class="col-md-6 d-flex justify-content-md-end mt-2 mt-md-0">
                        <label class="me-2">Arama:</label>
                        <input type="search" id="dt-search" class="form-control w-auto">
                    </div>
                </div>

                <table id="example" class="table table-striped table-bordered display" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Yazılım Kodu</th>
                            <th>Yazılım Adı</th>
                            <th>Revizyon No</th>
                            <th>Dosya Türü</th>
                            <th>Açıklama</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- yazılım ekle başlangıcı -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form id="createForm">
                <div class="modal-header">
                    <h5 class="modal-title">Yeni Yazlım Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Yazılım Bilgileri -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Yazılım Kodu*</label>
                            <input type="text" class="form-control" name="yazilimKodu" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Yazılım Tanımlaması*</label>
                            <input type="text" class="form-control" name="yazilimTanimlamasi" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Dosya Türü* (hex./bat.)*</label>
                            <input type="text" class="form-control" name="dosyaTuru" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Dosya Türü* (hex./bat.)</label>
                            <input type="file"
                                   class="form-control"
                                   name="dosyaTuru"
                                   required
                                   data-preview="#previewProg"
                                   accept=".hex,.bat"
                                   multiple />
                            <div id="previewProg" class="d-flex gap-2 mt-2 flex-wrap"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Revizyon No*</label>
                            <input type="text" class="form-control" name="revizyonNo" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Açıklama*</label>
                            <input type="text" class="form-control" name="aciklama" required />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- yazılım ekle bitişi -->
<!-- Yazılım Düzenle Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form id="editForm">
                <div class="modal-header">
                    <h5 class="modal-title">🛠 Yazılımı Düzenle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Yazılım Kodu</label>
                            <input type="text" class="form-control" name="yazilimKodu" id="editYazilimKodu" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Yazılım Tanımlaması</label>
                            <input type="text" class="form-control" name="yazilimTanimlamasi" id="editYazilimTanimlamasi" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Programlama Tipi</label>
                            <input type="text" class="form-control" name="programlamaTipi" id="editProgramlamaTipi" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Revizyon No</label>
                            <input type="text" class="form-control" name="revizyonNo" id="editRevizyonNo" required />
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Açıklama</label>
                            <input type="text" class="form-control" name="aciklama" id="editAciklama" required />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Yazılım Düzenle Modal bitişi -->
<!-- Revizyonlar Modal -->
<div class="modal fade" id="revizyonModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yazılım Revizyonları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <!-- Seçilen Yazılım Bilgileri -->
                <div class="mb-3">
                    <p><strong>Yazılım ID:</strong> <span id="revizyonYazilimId"></span></p>
                    <p><strong>Yazılım Adı:</strong> <span id="revizyonYazilimAdi"></span></p>
                </div>

                <!-- Yeni Revizyon Yükleme -->
                <div class="card mb-4">
                    <div class="card-header">Yeni Revizyon Yükle</div>
                    <div class="card-body">
                        <form id="revizyonForm">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Revizyon No*</label>
                                    <input type="text" class="form-control" name="revizyonNo" required>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Revizyon Notları (Opsiyonel)</label>
                                    <input type="text" class="form-control" name="revizyonNotu" placeholder="Örn: Hata düzeltmeleri, yeni özellikler">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Revizyon Dosyası*</label>
                                    <input type="file"
                                           class="form-control"
                                           name="revizyonDosya"
                                           accept=".hex,.bat"
                                           required>
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button type="submit" class="btn btn-primary">Yükle</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Önceden Yüklenmiş Revizyonlar Listesi -->
                <div class="card">
                    <div class="card-header">Yüklenmiş Revizyonlar</div>
                    <div class="card-body">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Revizyon No</th>
                                    <th>Revizyon Notları</th>
                                    <th>Dosya</th>
                                    <th>Durum</th>
                                    <th>Yükleyen Kullanıcı</th>
                                    <th>Yükleme Tarihi </th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>



<!-- Modal'lar aynı kalıyor (Create, Edit, Revizyon) -->
<!-- Popup Modal -->
<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bilgi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="actionMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tamam</button>
            </div>
        </div>
    </div>
</div>
<!-- Popup Modal bitişi-->
</div>

<!-- Core JS -->
<!-- build:js assets/vendor/js/core.js -->
<script src="~/sneat-1.0.0/assets/vendor/libs/jquery/jquery.js"></script>
<script src="~/sneat-1.0.0/assets/vendor/libs/popper/popper.js"></script>
<script src="~/sneat-1.0.0/assets/vendor/js/bootstrap.js"></script>
<script src="~/sneat-1.0.0/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>


<script src="~/sneat-1.0.0/assets/vendor/js/menu.js"></script>
<!-- endbuild -->
<!-- Vendors JS -->
<script src="~/sneat-1.0.0/assets/vendor/libs/apex-charts/apexcharts.js"></script>

<!-- Main JS -->
<script src="~/sneat-1.0.0/assets/js/main.js"></script>

<!-- Page JS -->
<script src="~/sneat-1.0.0/assets/js/dashboards-analytics.js"></script>

<!-- Place this tag in your head or just before your close body tag. -->
<!-- Icons (Bootstrap Icons) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- DataTables Responsive CSS -->
<link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">


<!-- DataTables Responsive JS -->
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>


<script async defer src="https://buttons.github.io/buttons.js"></script>



<!-- JS -->
<script src="~/sneat-1.0.0/assets/vendor/libs/jquery/jquery.js"></script>
<script src="~/sneat-1.0.0/assets/vendor/js/bootstrap.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

<script>
       $("#example").DataTable({
        ajax: {
            url: 'https://localhost:7170/api/software',  // API URL'sini tam yaz
            type: 'GET',
            dataSrc: ""
        },
        columns: [
            { data: "id" },
            { data: "softwareCode" },   // dikkat, API response’daki property isimleriyle aynı olmalı
            { data: "name" },
            { data: "revisionNo" },
            { data: "programmingType" },
            { data: "description" },
            {
                data: null,
                render: function (data, type, row) {
                    return `
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-secondary btn-edit">Düzenle</button>
                            <button class="btn btn-sm btn-secondary btn-delete">Sil</button>
                            <button class="btn btn-sm btn-info btn-revizyon">Revizyon</button>
                        </div>`;
                }
            }
        ]
    });



        $("#dt-length").on("change", function () { table.page.len($(this).val()).draw(); });
        $("#dt-search").on("keyup", function () { table.search(this.value).draw(); });

        // 🔹 Silme (AJAX)
        $("#example").on("click", ".btn-delete", function () {
            let row = table.row($(this).closest("tr"));
            let data = row.data();
            Swal.fire({
                title: "Silinsin mi?", text: `${data.yazilimAdi} silinecek`,
                icon: "warning", showCancelButton: true,
                confirmButtonText: "Evet, Sil", cancelButtonText: "İptal"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/Yazilim/Delete/${data.id}`,
                        type: "POST",
                        success: function () {
                            row.remove().draw();
                            Swal.fire("Silindi", "Kayıt silindi", "success");
                        }
                    });
                }
            });
        });

        // 🔹 Düzenleme (form açma)
        $("#example").on("click", ".btn-edit", function () {
            let data = table.row($(this).closest("tr")).data();
            $("#editYazilimKodu").val(data.yazilimKodu);
            $("#editYazilimTanimlamasi").val(data.yazilimAdi);
            $("#editRevizyonNo").val(data.revizyonNo);
            $("#editProgramlamaTipi").val(data.dosyaTuru);
            $("#editAciklama").val(data.aciklama);
            $("#editForm").data("id", data.id);
            new bootstrap.Modal(document.getElementById("editModal")).show();
        });

        // 🔹 Düzenleme Kaydet (AJAX)
        $("#editForm").on("submit", function (e) {
            e.preventDefault();
            let id = $(this).data("id");
            let payload = {
                id: id,
                yazilimKodu: $("#editYazilimKodu").val(),
                yazilimAdi: $("#editYazilimTanimlamasi").val(),
                revizyonNo: $("#editRevizyonNo").val(),
                dosyaTuru: $("#editProgramlamaTipi").val(),
                aciklama: $("#editAciklama").val()
            };
            $.ajax({
                url: "/Yazilim/Update",
                type: "POST",
                data: payload,
                success: function () {
                    $("#editModal").modal("hide");
                    table.ajax.reload(null, false);
                    Swal.fire("Güncellendi", "Kayıt güncellendi", "success");
                }
            });
        });

        // 🔹 Yeni kayıt
        $(".create-new").on("click", function () {
            $("#createForm")[0].reset();
            new bootstrap.Modal(document.getElementById("createModal")).show();
        });
        $("#createForm").on("submit", function (e) {
            e.preventDefault();
            let payload = $(this).serialize();
            $.ajax({
                url: "/Yazilim/Create",
                type: "POST",
                data: payload,
                success: function () {
                    $("#createModal").modal("hide");
                    table.ajax.reload(null, false);
                    Swal.fire("Eklendi", "Yeni yazılım eklendi", "success");
                }
            });
        });
    });
</script>
